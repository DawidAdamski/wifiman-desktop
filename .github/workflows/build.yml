name: Build WiFiman RPM from Local DEB

on:
  push:
    paths:
      - 'deb/*.deb'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    # Tutaj odpalamy cały job bezpośrednio w Fedorze
    container:
      image: fedora:latest

    steps:
      - name: Install build dependencies
        run: |
          dnf install -y rpm-build binutils
          # ar jest w binutils, rpmbuild w rpm-build

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract Version and Build RPM
        id: info
        run: |
          # Znajdź plik deb
          DEB_PATH=$(ls deb/*.deb | head -n 1)
          FILENAME=$(basename "$DEB_PATH")
          VERSION=$(echo $FILENAME | grep -oP '\d+\.\d+\.\d+')
          
          echo "Building version: $VERSION"
          
          # Wypakowanie (jesteśmy wewnątrz kontenera Fedora)
          ar x "$DEB_PATH"
          tar xf data.tar.gz
          
          # Przygotowanie rpmbuild
          mkdir -p ~/rpmbuild/{SOURCES,SPECS,BUILD,RPMS,SRPMS}
          cp wifiman-desktop.spec ~/rpmbuild/SPECS/
          
          # Budowanie
          rpmbuild -bb ~/rpmbuild/SPECS/wifiman-desktop.spec \
            --define "_topdir $HOME/rpmbuild" \
            --define "_version ${VERSION}"
          
          # Przeniesienie gotowej paczki do folderu głównego
          cp ~/rpmbuild/RPMS/x86_64/*.rpm .
          
          # Przekazanie wersji do kolejnych kroków
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        # Ten krok wyjdzie z kontenera i użyje standardowego runnera do uploadu
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.info.outputs.version }}
          files: "*.rpm"
          body: "Repackaged WiFiman Desktop v${{ steps.info.outputs.version }} for Fedora."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

