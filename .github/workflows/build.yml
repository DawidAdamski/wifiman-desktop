name: Build WiFiman RPM from Local DEB

on:
  push:
    paths:
      - 'deb/*.deb'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    # Tutaj odpalamy cały job bezpośrednio w Fedorze
    container:
      image: fedora:latest

    steps:
      - name: Install build dependencies
        run: |
          dnf install -y rpm-build binutils systemd-rpm-macros

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract Version and Build RPM
        id: info
        run: |
          DEB_PATH=$(ls deb/*.deb | head -n 1)
          FILENAME=$(basename "$DEB_PATH")
          VERSION=$(echo $FILENAME | grep -oP '\d+\.\d+\.\d+')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # Wypakowanie w głównym katalogu
          ar x "$DEB_PATH"
          tar xf data.tar.gz

          # Przygotowanie struktur rpmbuild
          mkdir -p ~/rpmbuild/{SOURCES,SPECS,BUILD,RPMS,SRPMS}
          cp wifiman-desktop.spec ~/rpmbuild/SPECS/
          
          # Budowanie z przekazaniem ścieżki workspace
          rpmbuild -bb ~/rpmbuild/SPECS/wifiman-desktop.spec \
            --define "_topdir $HOME/rpmbuild" \
            --define "_version ${VERSION}" \
            --define "_ws $GITHUB_WORKSPACE"
          
          cp ~/rpmbuild/RPMS/x86_64/*.rpm .


      - name: Create GitHub Release
        # Ten krok wyjdzie z kontenera i użyje standardowego runnera do uploadu
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.info.outputs.version }}
          files: "*.rpm"
          body: "Repackaged WiFiman Desktop v${{ steps.info.outputs.version }} for Fedora."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

